<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>深空面板助手</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background-color: #f9f9f9;
      font-size: 16px;
    }

    h1, h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      text-align: center;
    }

    .toast {
      position: absolute;
      top: 350px;
      left: 50%;
      transform: translateX(-50%);
    }

    .form-label {
      margin-top: 10px;
      font-size: 1rem;
    }

    .record {
      border-left: 4px solid #0d6efd;
      background: #fff;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      font-size: 0.95rem;
    }

    .form-control::placeholder {
      color: #aaa;
    }

    .btn {
      font-size: 0.95rem;
    }

    @media (max-width: 576px) {
      .col-md-4, .col-md-3 {
        flex: 0 0 100%;
        max-width: 50%;
      }

      h1, h2 {
        font-size: 1.25rem;
      }

      .btn {
        width: 100%;
        margin-top: 5px;
      }

      #action-buttons .btn {
        width: 48%;
      }
    }
  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-V32YDXY183"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-V32YDXY183');
</script>
<body>
<h1>锦标赛满星面板查询</h1>

<!-- 基础输入 -->
<div class="mb-3">
  <label for="level" class="form-label">选择关卡：</label>
  <select id="level" class="form-select">
    <option value="">--请选择--</option>
  </select>
</div>

<!-- 动作按钮 -->
<div id="action-buttons" class="mb-3">
  <button id="fetch-records" class="btn btn-outline-primary me-2">获取面板记录</button>
  <button id="start-upload" class="btn btn-outline-success">上传面板记录</button>
</div>

<!-- 动态面板输入 -->
<div id="panel-inputs" class="row g-2 mb-3 d-none"></div>
<button id="submit" class="btn btn-primary w-100 d-none">提交记录</button>

<!-- 展示记录 -->
<h2 id="records-title" class="mt-5 d-none">面板记录</h2>
<div id="records" class= "d-none"></div>
<div id="pagination" class="mt-3 d-flex justify-content-center"></div>

<h2 id="latest-records-title" class="mt-5">最新面板记录</h2>
<div id="latest-records"></div>

<div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="toast-header">
    <strong class="me-auto" id="toast-header"></strong>
    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
  <div class="toast-body" id="toast-body"></div>
</div>

<script type="module">
  import { apiGet, apiPost } from './scripts/util.js';
  import * as constants from './scripts/constants.js';

  const levelSelect = document.getElementById("level");
  const panelInputsDiv = document.getElementById("panel-inputs");
  const latestRecordsDiv = document.getElementById("latest-records");
  const latestRecordsTitle = document.getElementById("latest-records-title")
  const recordsDiv = document.getElementById("records");
  const submitButton = document.getElementById("submit");
  const recordsTitle = document.getElementById("records-title")

  const PAGE_SIZE = 10;

  const LEVEL_TYPES = [ "A4", "B4", "C4" ]

  const PANEL_KEYS = [
    "生命", "攻击", "防御", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档", "搭档身份", "日卡", "阶数", "武器", "加成"
  ];

  const DISPLAY_PANEL_KEYS = [
    "攻击", "防御", "生命", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档身份", "日卡", "阶数", "武器", "加成"
  ];

  const LATEST_DISPLAY_PANEL_KEYS = [
    "关卡", "攻击", "防御", "生命", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档身份", "日卡", "阶数", "武器", "加成"
  ];

  // 初始化关卡类型
  LEVEL_TYPES.forEach((key) => {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = key;
    levelSelect.appendChild(option);
  });

  showLatestRecords();

  function updatePartnerDropdown() {
    const partnerSelect = document.getElementById("input-搭档");

    partnerSelect.innerHTML = `<option value="">--搭档--</option>` + constants.DROPDOWN_VALUES["搭档"].map(v => `<option value="${v}">${v}</option>`).join("");
    refreshPartnerAndSetDropdowns();
  }

  // 填充输入表单
  PANEL_KEYS.forEach(key => {
    const wrapper = document.createElement("div");
    wrapper.className = "col-md-4";
    if (constants.DROPDOWN_VALUES[key]) {
      const select = document.createElement("select");
      select.id = `input-${key}`;
      select.className = "form-select";
      select.innerHTML = `<option value="">--${key}--</option>` + constants.DROPDOWN_VALUES[key].map(v => `<option value="${v}">${v}</option>`).join("");
      wrapper.appendChild(select);
    } else {
      const input = document.createElement("input");
      input.placeholder = key;
      input.type = "number"
      input.id = `input-${key}`;
      input.className = "form-control";
      wrapper.appendChild(input);
    }
    panelInputsDiv.appendChild(wrapper);
  });

  function getFormData() {
    const data = {};
    PANEL_KEYS.forEach(key => {
      data[key] = document.getElementById(`input-${key}`).value.trim();
    });
    data["时间"]= new Date().toISOString();
    return data;
  }

  function showRecords(page = 1) {
    hideLatestRecords();
    recordsTitle.classList.remove("d-none");
    recordsDiv.classList.remove("d-none");

    const level = levelSelect.value;

    const offset = (page - 1) * PAGE_SIZE;

    apiGet('championships-records', { level, offset })
            .then(result => {
              let cnt = result.total
              let list = result.records || [];

              recordsDiv.innerHTML = list.map(r => {
                const panelRows = DISPLAY_PANEL_KEYS.map((k, i) => {
                  const content = `<strong>${k}:</strong> ${r[k] || "-"}`;
                  const col = `<div class="col-md-3">${content}</div>`;
                  return (i % 4 === 0 ? '<div class="row mb-1">' : '') + col + (i % 4 === 3 || i === DISPLAY_PANEL_KEYS.length - 1 ? '</div>' : '');
                }).join("");
                // return `<div class="record">${panelRows}<div class="text-muted small mt-2">${r.时间 || ""}</div></div>`;
                return `<div class="record">${panelRows}</div>`;
              }).join("") || "暂无记录";

              const totalPages = Math.ceil(cnt / PAGE_SIZE);
              const paginationDiv = document.getElementById("pagination");
              paginationDiv.innerHTML = "";

              if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                  const btn = document.createElement("button");
                  btn.className = `btn btn-sm mx-1 ${i === page ? "btn-primary" : "btn-outline-primary"}`;
                  btn.textContent = i;
                  btn.addEventListener("click", () => showRecords(i));
                  paginationDiv.appendChild(btn);
                }
              }
            })
            .catch(err => {
              console.error("获取失败", err);
              alert("获取失败：" + err.message);
            });
  }

  function showLatestRecords() {
    apiGet('latest-championships-records', {})
            .then(result => {
              let list = result.records || [];

              latestRecordsDiv.innerHTML = list.map(r => {
                const panelRows = LATEST_DISPLAY_PANEL_KEYS.map((k, i) => {
                  const content = `<strong>${k}:</strong> ${r[k] || "-"}`;
                  const col = `<div class="col-md-3">${content}</div>`;
                  return (i % 4 === 0 ? '<div class="row mb-1">' : '') + col + (i % 4 === 3 || i === LATEST_DISPLAY_PANEL_KEYS.length - 1 ? '</div>' : '');
                }).join("");
                return `<div class="record">${panelRows}</div>`;
              }).join("") || "暂无记录";
            })
            .catch(err => {
              console.error("获取失败", err);
              alert("获取失败：" + err.message);
            });
  }

  function hideLatestRecords() {
    latestRecordsTitle.classList.add("d-none");
    latestRecordsDiv.classList.add("d-none");
  }

  function showToast(title, message, duration = 3000) {
    const toast = document.getElementById("toast");
    toast.style.display = "block";
    setTimeout(() => {
      toast.style.display = "none";
    }, duration);

    const toastTitle = document.getElementById("toast-header");
    const toastBody = document.getElementById("toast-body");
    toastTitle.innerText = title;
    toastBody.innerText = message;
  }

  // 获取记录
  const fetchBtn = document.getElementById("fetch-records");
  fetchBtn.addEventListener("click", () => {
    if (fetchBtn.disabled) return;
    fetchBtn.disabled = true;
    showRecords();
    setTimeout(() => {
      fetchBtn.disabled = false;
    }, 3000);
  });

  // 显示上传表单
  document.getElementById("start-upload").addEventListener("click", () => {
    hideLatestRecords();
    panelInputsDiv.classList.remove("d-none");
    submitButton.classList.remove("d-none");
  });

  // 提交记录
  submitButton.addEventListener("click", () => {
    if (submitButton.disabled) return;
    submitButton.disabled = true;

    const level = levelSelect.value;
    const data = getFormData();
    const record = { 关卡: level, ...data };

    apiPost('championships-record', record)
            .then(response => {
              if (response.status === 'OK') {
                showToast("上传成功", "Thanks♪(･ω･)ﾉ感谢您的使用！", 3000);
                panelInputsDiv.classList.add("d-none");
                submitButton.classList.add("d-none");
                showRecords(); // 可选刷新记录
              } else {
                showToast("上传失败", response.error, 3000);
              }
            })
            .catch(err => showToast("上传失败", err.message, 3000));

    setTimeout(() => {
      submitButton.disabled = false;
    }, 3000);
  });

  levelSelect.addEventListener("change", () => {
    updatePartnerDropdown();
  });

  function refreshPartnerAndSetDropdowns() {
    const partnerSelect = document.getElementById("input-搭档");
    const selectedPartner = partnerSelect.value;

    let partnerOptions = constants.DROPDOWN_VALUES["搭档身份"];
    let setOptions = constants.DROPDOWN_VALUES["日卡"];

    if (selectedPartner) {
      const partnerKey = `${selectedPartner}搭档`;
      partnerOptions = constants.DROPDOWN_VALUES[partnerKey]

      const setKey = `${selectedPartner}日卡`;
      setOptions = constants.DROPDOWN_VALUES[setKey];
    }

    const partnerStyleSelect = document.getElementById("input-搭档身份");
    partnerStyleSelect.innerHTML = `<option value="">--搭档身份--</option>` + partnerOptions.map(v => `<option value="${v}">${v}</option>`).join("");

    const setSelect = document.getElementById("input-日卡");
    setSelect.innerHTML = `<option value="">--日卡--</option>` + setOptions.map(v => `<option value="${v}">${v}</option>`).join("");
  }

  const partnerSelect = document.getElementById("input-搭档");
  partnerSelect.addEventListener("change", () => {
    refreshPartnerAndSetDropdowns()
  })
</script>
</body>
</html>
