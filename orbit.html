<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>深空面板助手</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./styles/common.css" />
    <link rel="stylesheet" type="text/css" href="./styles/custom-select.css" />
    <link rel="stylesheet" type="text/css" href="./styles/record.css" />
    <style>
        body {
            height: 100vh;
            color: white;
            background: linear-gradient(0deg, #23314c, #45324c);
            overflow: hidden;
        }

        h1, h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }

        .main-content {
            overflow: scroll;
            scrollbar-width: none;
        }
        .main-content::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .content-wrapper {
            width: 80vw;
            max-width: 350px;
            min-width: 250px;
            min-height: 95vh;
            margin: 0 auto
        }

        .btn {
            text-align: center;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .form-control::placeholder {
            color: #aaa;
        }

        .row {
            padding: 5px 10px 5px 10px;
            --bs-gutter-x: 0;
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.6);
        }

        .btn {
            font-size: 0.95rem;
        }

        .upload-fetch-btn {
            border: 0;
            background-color: cadetblue;
        }
        .upload-fetch-btn:hover,
        .upload-fetch-btn:focus {
            background-color: cadetblue;
            color: inherit;
        }

        .upload-action-btn {
            border: 0;
            background-color: palevioletred;
        }
        .upload-action-btn:hover,
        .upload-action-btn:focus {
            background-color: palevioletred;
            color: inherit;
        }

        .submit-btn {
            border: 0;
            background-color: darkslateblue;
            margin-top: 20px;
        }
        .submit-btn:hover,
        .submit-btn:focus {
            background-color: darkslateblue;
            color: inherit;
        }

        .footer {
            position: initial;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-V32YDXY183"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-V32YDXY183');
</script>
<body>
<div class="main-content">
    <a href="./index.html" style="text-decoration: none; color: inherit;">
        <label class="back-button"><img class="back-icon" src="assets/back.PNG" /></label>
    </a>
    <div class="content-wrapper">
        <h1>轨道面板查询</h1>
        <hr />

        <!-- 基础输入 -->
        <div class="display-row">
            <div class="w-50">
                <div class="custom-select">
                    <div id="level-type" class="selected">--选择关卡--</div>
                    <ul class="options">
                        <li>光</li>
                        <li>冰</li>
                        <li>火</li>
                        <li>能量</li>
                        <li>引力</li>
                        <li>开放</li>
                    </ul>
                </div>
            </div>
            <div class="w-50">
                <input id="level-number" type="number" class="form-control" placeholder="关卡编号" min="1">
            </div>
        </div>

        <!-- 上下段 -->
        <div class="d-none display-row" id="part-container">
            <div class="custom-select w-100">
                <div id="level-part" class="selected">--选择上下--</div>
                <ul class="options">
                    <li>上</li>
                    <li>下</li>
                </ul>
            </div>
        </div>

        <!-- 动作按钮 -->
        <div id="action-buttons" class="display-row d-none">
            <button id="fetch-records" class="btn upload-fetch-btn w-50">获取记录</button>
            <button id="start-upload" class="btn upload-action-btn w-50">上传记录</button>
        </div>

        <!-- 动态面板输入 -->
        <hr />
        <div id="panel-inputs" class="d-none"></div>
        <button id="submit" class="btn submit-btn w-100 d-none">提交记录</button>

        <!-- 展示记录 -->
        <h2 id="records-title" class="mt-5 d-none">关卡面板记录</h2>
        <div id="records" class="d-none"></div>
        <div id="pagination" class="mt-3 d-flex justify-content-center"></div>

        <!-- 展示最新记录 -->
        <h2 id="latest-records-title" class="mt-5">最新上传面板</h2>
        <div id="latest-records">
            <div class="w-100 record">
                <div class="row">
                    <div class="col-6 record-matching-detail record-grid">
                        <label class="record-matching is-matching">顺</label>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="darkseagreen">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle-fill"/>
                        </svg>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="darkseagreen">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle-fill"/>
                        </svg>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="darkseagreen">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle-fill"/>
                        </svg>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="darkseagreen">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle-fill"/>
                        </svg>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="currentColor">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle"/>
                        </svg>
                        <svg class="bi record-matching-circle" width="15" height="15" fill="currentColor">
                            <use xlink:href="node_modules/bootstrap-icons/bootstrap-icons.svg#circle"/>
                        </svg>
                    </div>
                    <div class="col-6 record-level-detail record-grid">
                        <label class="record-level-type">开放</label>
                        <label class="record-level-number">120</label>
                        <label class="record-level-part">上</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 record-grid record-grid-padding-right">
                        <div class="record-partner partner-X-02">
                            终极兵器X-02
                        </div>
                    </div>
                    <div class="col-3 record-grid record-grid-padding-left-right">
                        <div class="record-set-card set-card-purple">
                            寂路 IV
                        </div>
                    </div>
                    <div class="col-3 record-grid record-grid-padding-left">
                        <div class="record-weapon weapon-rare">
                            专武
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 record-grid record-flex-row record-grid-padding-right">
                        <label class="record-text-label">攻击:</label>
                        <label class="record-number-label">10824</label>
                    </div>
                    <div class="col-6 record-grid record-flex-row record-grid-padding-left">
                        <label class="record-text-label">生命:</label>
                        <label class="record-number-label">183824</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 record-grid record-flex-row record-grid-padding-right">
                        <label class="record-text-label">防御:</label>
                        <label class="record-number-label">3824</label>
                    </div>
                    <div class="col-6 record-grid record-flex-row record-grid-padding-left">
                        <label class="record-text-label">虚弱增伤:</label>
                        <label class="record-number-label">148.4%</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 record-grid record-flex-row record-grid-padding-right">
                        <label class="record-text-label">暴击:</label>
                        <label class="record-number-label">79.4%</label>
                    </div>
                    <div class="col-6 record-grid record-flex-row record-grid-padding-left">
                        <label class="record-text-label">暴伤:</label>
                        <label class="record-number-label">279.4%</label>
                    </div>
                    </div>
                <div class="row">
                    <div class="col-6 record-grid record-flex-row record-grid-padding-right">
                        <label class="record-text-label">誓约增伤:</label>
                        <label class="record-number-label">24.4%</label>
                    </div>
                    <div class="col-6 record-grid record-flex-row record-grid-padding-left">
                        <label class="record-text-label">誓约回能:</label>
                        <label class="record-number-label">17.3%</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 record-grid record-flex-row record-grid-padding-right">
                        <label class="record-text-label">加速回能:</label>
                        <label class="record-number-label">24.4%</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-header"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>
    <footer class="footer">
        <div>Contact：小红书：900197975 / 微信: rabbitlink</div>
    </footer>
</div>

<script type="module">
    import { apiGet, apiPost } from './scripts/util.js';
    import { initCustomSelects } from './scripts/custom_select.js';
    import * as constants from './scripts/constants.js';

    const levelTypeSelect = document.getElementById("level-type");
    const levelNumberInput = document.getElementById("level-number");
    const levelPartSelect = document.getElementById("level-part");
    const partContainer = document.getElementById("part-container");
    const panelInputsDiv = document.getElementById("panel-inputs");
    const recordsDiv = document.getElementById("records");
    const latestRecordsDiv = document.getElementById("latest-records");
    const latestRecordsTitle = document.getElementById("latest-records-title")
    const submitButton = document.getElementById("submit");
    const actionButtons = document.getElementById("action-buttons");
    const recordsTitle = document.getElementById("records-title")

    const PAGE_SIZE = 10;

    const PANEL_KEYS = [
        "生命", "攻击", "防御", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档", "搭档身份", "日卡", "阶数", "武器"
    ];

    const DISPLAY_PANEL_KEYS = [
        "攻击", "防御", "生命", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档身份", "日卡", "阶数", "武器"
    ];

    const LATEST_DISPLAY_PANEL_KEYS = [
        "关卡", "关数", "攻击", "防御", "生命", "暴击", "暴伤", "誓约增伤", "誓约回能", "加速回能", "虚弱增伤", "对谱", "对谱加成", "搭档身份", "日卡", "阶数", "武器"
    ];

    // showLatestRecords();

    let rowWrappers = [];
    PANEL_KEYS.forEach(function(key, index) {
        const wrapper = document.createElement("div");
        wrapper.className = "w-50";
        if (constants.DROPDOWN_VALUES[key]) {
            const customSelect = document.createElement("div");
            customSelect.className = "custom-select";
            customSelect.innerHTML = `
                <div id="input-${key}" class="selected">--${key}--</div>
                <ul class="options">
                    ${constants.DROPDOWN_VALUES[key].map(v => `<li>${v}</li>`).join("")}
                </ul>
            `;
            wrapper.appendChild(customSelect);
        } else {
            const input = document.createElement("input");
            input.placeholder = key;
            input.type = "number"
            input.id = `input-${key}`;
            input.className = "form-control";
            wrapper.appendChild(input);
        }
        rowWrappers.push(wrapper);

        // 每两个包裹进 display-row
        if (rowWrappers.length === 2 || index === PANEL_KEYS.length - 1) {
            const rowDiv = document.createElement("div");
            rowDiv.className = "display-row";
            rowWrappers.forEach(w => rowDiv.appendChild(w));
            panelInputsDiv.appendChild(rowDiv);
            rowWrappers = [];
        }
    });

    initCustomSelects()

    function showToast(title, message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.style.display = "block";
        setTimeout(() => {
            toast.style.display = "none";
        }, duration);

        const toastTitle = document.getElementById("toast-header");
        const toastBody = document.getElementById("toast-body");
        toastTitle.innerText = title;
        toastBody.innerText = message;
    }

    // 获取记录
    const fetchBtn = document.getElementById("fetch-records");
    fetchBtn.addEventListener("click", () => {
        if (fetchBtn.disabled) return;
        fetchBtn.disabled = true;
        console.log("获取记录...");
        hideInputSection();
        hideLatestRecords();
        showRecords();
        setTimeout(() => {
            fetchBtn.disabled = false;
        }, 3000);
    });

    // 显示上传表单
    document.getElementById("start-upload").addEventListener("click", () => {
        hideLatestRecords();
        panelInputsDiv.classList.remove("d-none");
        submitButton.classList.remove("d-none");
    });

    // 提交记录
    submitButton.addEventListener("click", () => {
        if (submitButton.disabled) return;
        submitButton.disabled = true;

        const type = levelTypeSelect.innerHTML;
        const number = parseInt(levelNumberInput.value);
        const selected = constants.LEVEL_TYPES.find(l => l.type === type);

        if (!type || !number || !selected || number < 1 || number > selected.count) {
            showToast("请求错误", "请正确填写关卡类型和编号！", 3000);
            return;
        }

        const levelNumber = getLevelNumber();
        const data = getFormData();
        const record = { 关卡: type, 关数: levelNumber, ...data };

        apiPost('orbit-record', record)
            .then(response => {
                if (response.status === 'OK') {
                    showToast("上传成功", "Thanks♪(･ω･)ﾉ感谢您的使用！", 3000);
                    panelInputsDiv.classList.add("d-none");
                    submitButton.classList.add("d-none");
                    showRecords(); // 可选刷新记录
                } else {
                    showToast("上传失败", response.error, 3000);
                }
            })
            .catch(err => showToast("上传失败", err.message, 3000));

        setTimeout(() => {
            submitButton.disabled = false;
        }, 3000);
    });

    const levelTypeObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                validatePartDropdown();
                updatePartnerDropdown();
                checkIfReady();
            }
        }
    });

    levelTypeObserver.observe(levelTypeSelect, {
        childList: true,
        subtree: false,
    });

    levelNumberInput.addEventListener("input", () => {
        validatePartDropdown();
        checkIfReady();
    });

    levelPartSelect.addEventListener("change", checkIfReady);
    const levelPartObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                checkIfReady();
            }
        }
    });

    levelPartObserver.observe(levelPartSelect, {
        childList: true,
        subtree: false,
    });

    const partnerSelect = document.getElementById("input-搭档");
    partnerSelect.addEventListener("change", checkIfReady);
    const partnerObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'childList') {
                refreshPartnerAndSetDropdowns()
            }
        }
    });

    partnerObserver.observe(partnerSelect, {
        childList: true,
        subtree: false,
    });

    document.querySelectorAll('.btn-close').forEach(btn => {
        btn.addEventListener('click', function() {
            const toast = this.closest('.toast');
            if (toast) toast.style.display = 'none';
        });
    });

    function validatePartDropdown() {
        const type = levelTypeSelect.innerHTML;
        const number = parseInt(levelNumberInput.value);
        const selected = constants.LEVEL_TYPES.find(l => l.type === type);
        if (selected && number && number % 10 === 0 && number >= 1 && number <= selected.count) {
            partContainer.classList.remove("d-none");
        } else {
            partContainer.classList.add("d-none");
        }
    }

    function updatePartnerDropdown() {
        const type = levelTypeSelect.innerHTML;
        const partnerSelect = document.getElementById("input-搭档");

        if (type === "开放") {
            partnerSelect.innerHTML = "--搭档--";
            const partnerOptions = partnerSelect.nextElementSibling;
            partnerOptions.innerHTML = constants.DROPDOWN_VALUES["搭档"].map(v => `<li>${v}</li>`).join("");
            refreshPartnerAndSetDropdowns();
            return;
        }

        const levelPartnerMap = {
            "光": "沈星回",
            "冰": "黎深",
            "火": "祁煜",
            "能量": "秦彻",
            "引力": "夏以昼"
        };

        partnerSelect.innerHTML = levelPartnerMap[type];
        const partnerOptions = partnerSelect.nextElementSibling;
        partnerOptions.innerHTML = `<li>${levelPartnerMap[type]}</li>`;
        refreshPartnerAndSetDropdowns();
    }

    function checkIfReady() {
        const type = levelTypeSelect.innerHTML;
        const number = parseInt(levelNumberInput.value);
        const selected = constants.LEVEL_TYPES.find(l => l.type === type);
        const hasValuesAndNumber = type && number && selected
        if (hasValuesAndNumber) {
            const isValidNumber = number >= 1 && number <= selected.count
            if (isValidNumber) {
                if (number % 10 !== 0) {
                    actionButtons.classList.remove("d-none");
                    return;
                } else if (levelPartSelect.innerHTML === "上" || levelPartSelect.innerHTML === "下") {
                    actionButtons.classList.remove("d-none");
                    return;
                }
            }
        }

        actionButtons.classList.add("d-none");
    }

    function getFormData() {
        const data = {};
        PANEL_KEYS.forEach(key => {
            let val = document.getElementById(`input-${key}`).innerHTML.trim();
            if (val === "") {
                val = document.getElementById(`input-${key}`).value.trim();
            }
            data[key] = val;
        });
        data["时间"]= new Date().toISOString();
        return data;
    }

    function getLevelNumber() {
        const number = parseInt(levelNumberInput.value);
        if (number % 10 === 0 && !partContainer.classList.contains("d-none")) {
            return `${number}_${levelPartSelect.value}`;
        }
        return number;
    }

    function showRecords(page = 1) {
        recordsTitle.classList.remove("d-none");
        recordsDiv.classList.remove("d-none");

        const type = levelTypeSelect.innerHTML;
        const level = getLevelNumber();

        const offset = (page - 1) * PAGE_SIZE;

        apiGet('orbit-records', { type, level, offset })
            .then(result => {
                let cnt = result.total
                let list = result.records || [];

                recordsDiv.innerHTML = list.map(r => {
                    const panelRows = DISPLAY_PANEL_KEYS.map((k, i) => {
                        const content = `<strong>${k}:</strong> ${r[k] || "-"}`;
                        const col = `<div class="col-md-3">${content}</div>`;
                        return (i % 4 === 0 ? '<div class="row mb-1">' : '') + col + (i % 4 === 3 || i === DISPLAY_PANEL_KEYS.length - 1 ? '</div>' : '');
                    }).join("");
                    // return `<div class="record">${panelRows}<div class="text-muted small mt-2">${r.时间 || ""}</div></div>`;
                    return `<div class="record">${panelRows}</div>`;
                }).join("") || "暂无记录";

                const totalPages = Math.ceil(cnt / PAGE_SIZE);
                const paginationDiv = document.getElementById("pagination");
                paginationDiv.innerHTML = "";

                if (totalPages > 1) {
                    for (let i = 1; i <= totalPages; i++) {
                        const btn = document.createElement("button");
                        btn.className = `btn btn-sm mx-1 ${i === page ? "btn-primary" : "btn-outline-primary"}`;
                        btn.textContent = i;
                        btn.addEventListener("click", () => showRecords(i));
                        paginationDiv.appendChild(btn);
                    }
                }
            })
            .catch(err => {
                console.error("获取失败", err);
                showToast("获取失败", err.message, 5000);
            });
    }

    function showLatestRecords() {
        apiGet('latest-orbit-records', {})
            .then(result => {
                let list = result.records || [];

                latestRecordsDiv.innerHTML = list.map(r => {
                    const panelRows = LATEST_DISPLAY_PANEL_KEYS.map((k, i) => {
                        const content = `<strong>${k}:</strong> ${r[k] || "-"}`;
                        const col = `<div class="col-md-3">${content}</div>`;
                        return (i % 4 === 0 ? '<div class="row mb-1">' : '') + col + (i % 4 === 3 || i === LATEST_DISPLAY_PANEL_KEYS.length - 1 ? '</div>' : '');
                    }).join("");
                    return `<div class="record">${panelRows}</div>`;
                }).join("") || "暂无记录";
            })
            .catch(err => {
                console.error("获取失败", err);
                showToast("获取失败", err.message, 5000);
            });
    }

    function hideLatestRecords() {
        latestRecordsTitle.classList.add("d-none");
        latestRecordsDiv.classList.add("d-none");
    }

    function hideInputSection() {
        panelInputsDiv.classList.add("d-none");
        submitButton.classList.add("d-none");
    }

    function refreshPartnerAndSetDropdowns() {
        const partnerSelect = document.getElementById("input-搭档");
        const selectedPartner = partnerSelect.innerHTML;

        let partnerOptions = constants.DROPDOWN_VALUES["搭档身份"];
        let setOptions = constants.DROPDOWN_VALUES["日卡"];

        if (selectedPartner) {
            const partnerKey = `${selectedPartner}搭档`;
            partnerOptions = constants.DROPDOWN_VALUES[partnerKey]

            const setKey = `${selectedPartner}日卡`;
            setOptions = constants.DROPDOWN_VALUES[setKey];
        }

        const partnerStyleSelect = document.getElementById("input-搭档身份");
        const setSelect = document.getElementById("input-日卡");

        partnerStyleSelect.innerHTML = "--搭档身份--";
        const partnerStyleOptions = partnerStyleSelect.nextElementSibling;
        partnerStyleOptions.innerHTML = partnerOptions.map(v => `<li>${v}</li>`).join("");

        setSelect.innerHTML = "--日卡--";
        const setOptionsList = setSelect.nextElementSibling;
        setOptionsList.innerHTML = setOptions.map(v => `<li>${v}</li>`).join("");
    }
</script>
</body>
</html>
